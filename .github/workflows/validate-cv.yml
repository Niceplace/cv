name: Validate CV

on:
  push:
    branches:
      - main
    paths:
      - 'resume-*.json'
  pull_request:
    branches:
      - main
    paths:
      - 'resume-*.json'

jobs:
  validate-resume:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 'lts/*'

      - name: Install resumed
        run: npm install -g resumed

      - name: Validate resume
        id: validate
        run: |
          # Note: resume-base.json is the canonical CV file per repository conventions
          # Store validation output and capture exit code
          set +e
          VALIDATION_RESULT=$(resumed validate resume-base.json 2>&1)
          VALIDATION_EXIT_CODE=$?
          set -e
          
          if [ "$VALIDATION_EXIT_CODE" -eq 0 ]; then
            echo "validation_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_status=failed" >> "$GITHUB_OUTPUT"
            {
              echo "validation_output<<EOF"
              echo "$VALIDATION_RESULT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment on validation failure
        if: steps.validate.outputs.validation_status == 'failed' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get validation error from step output
          VALIDATION_OUTPUT="${{ steps.validate.outputs.validation_output }}"
          
          # Create a unique identifier for our validation comment
          COMMENT_MARKER="<!-- resume-validation-workflow-comment -->"
          
          # Create comment body (using printf for proper formatting)
          # shellcheck disable=SC2016
          printf -v COMMENT_BODY '%s\n%s\n\n%s\n\n```text\n%s\n```\n\n%s' \
            "$COMMENT_MARKER" \
            "## ‚ùå Resume Validation Failed" \
            "The resume validation failed with the following errors:" \
            "$VALIDATION_OUTPUT" \
            "Please fix the validation errors and push the changes again."
          
          # Check if a comment already exists with our unique marker
          COMMENT_ID=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq ".comments[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$COMMENT_BODY"
          else
            # Create new comment
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          fi

      - name: Fail workflow if validation failed
        if: steps.validate.outputs.validation_status == 'failed'
        run: exit 1
