name: Validate, render and publish resume

on:
  push:
    branches:
      - main
    paths:
      - 'resume-*.json'
  pull_request:
    branches:
      - main
    paths:
      - 'resume-*.json'

jobs:
  validate-resume:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install validation dependencies
        run: bun add resumed

      - name: Validate resume
        id: validate
        run: |
          # Note: resume-base.json is the canonical CV file per repository conventions
          
          # Run validation using the TypeScript script with Bun runtime
          set +e
          VALIDATION_RESULT=$(bun .github/scripts/validate-resume.ts resume-base.json 2>&1)
          VALIDATION_EXIT_CODE=$?
          set -e
          
          if [ "$VALIDATION_EXIT_CODE" -eq 0 ]; then
            echo "validation_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_status=failed" >> "$GITHUB_OUTPUT"
            {
              echo "validation_output<<EOF"
              echo "$VALIDATION_RESULT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment on validation failure
        if: steps.validate.outputs.validation_status == 'failed' && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATION_OUTPUT: ${{ steps.validate.outputs.validation_output }}
        run: |
          # Use the TypeScript post-pr-comment script with Bun runtime
          # Pass validation output via environment variable to avoid bash escaping issues
          bun .github/scripts/post-pr-comment.ts "$VALIDATION_OUTPUT" "${{ github.event.pull_request.number }}"

      - name: Fail workflow if validation failed
        if: steps.validate.outputs.validation_status == 'failed'
        run: exit 1

  publish-resume:
      needs: validate-resume
      runs-on: ubuntu-latest
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      permissions:
        contents: read
        
      steps:
        - name: Checkout code
          uses: actions/checkout@v6.0.1

        - name: Publish resume to gist
          env:
            GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          run: |
            gh gist edit 8e587fe79ca40a637589b1d2d5c9373d resume-base.json

  render-resume:
    needs: validate-resume
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Placeholder step
        run: echo "Placeholder for render-resume job"
