name: Validate CV

on:
  push:
    branches:
      - main
    paths:
      - 'resume-*.json'
  pull_request:
    branches:
      - main
    paths:
      - 'resume-*.json'

jobs:
  validate-resume:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 'lts/*'

      - name: Install validation dependencies
        run: npm install resumed

      - name: Validate resume
        id: validate
        run: |
          # Note: resume-base.json is the canonical CV file per repository conventions
          
          # Create a validation wrapper that fixes the resumed CLI crash bug
          # and provides clearer error messages
          cat > validate-wrapper.js << 'VALIDATION_SCRIPT'
          #!/usr/bin/env node
          
          import { validate } from 'resumed';
          
          const resumeFile = process.argv[2] || 'resume-base.json';
          
          try {
            console.log(\`Validating \${resumeFile} with resumed CLI...\\n\`);
            await validate(resumeFile);
            console.log(\`✓ Your \${resumeFile} looks amazing! ✨\`);
            process.exit(0);
          } catch (err) {
            // Check if it's the expected validation error array from @jsonresume/schema
            if (Array.isArray(err)) {
              console.error(\`❌ Resume validation failed with \${err.length} error(s):\\n\`);
              
              err.forEach((error, index) => {
                console.error(\`Error \${index + 1}:\`);
                console.error(\`  Location: \${error.path || 'unknown'}\`);
                console.error(\`  Issue: \${error.message}\`);
                
                // Provide helpful context for common error patterns
                if (error.message && error.message.includes('does not match pattern')) {
                  if (error.path && error.path.includes('Date')) {
                    console.error(\`  → Dates must be in ISO 8601 format: YYYY-MM-DD, YYYY-MM, or YYYY\`);
                    console.error(\`     Examples: "2023-06", "2023", "2023-06-15"\`);
                  }
                } else if (error.message && error.message.includes('does not conform to the "uri" format')) {
                  console.error(\`  → URLs must be valid URIs (e.g., "https://example.com")\`);
                  console.error(\`     Empty strings are not valid. Use a proper URL or remove the field.\`);
                }
                
                console.error('');
              });
              
              console.error('For the complete JSON Resume schema specification, visit:');
              console.error('https://github.com/jsonresume/resume-schema/blob/master/schema.json\\n');
              
              process.exit(1);
            } else {
              // Some other error (file not found, JSON parse error, etc.)
              console.error('\\n❌ Validation encountered an error:\\n');
              console.error(err.message || err);
              
              if (err.code === 'ENOENT') {
                console.error(\`\\nThe file '\${resumeFile}' was not found.\`);
              } else if (err instanceof SyntaxError) {
                console.error('\\nThe file contains invalid JSON. Please check the syntax.');
              }
              
              console.error('');
              process.exit(1);
            }
          }
          VALIDATION_SCRIPT
          
          # Run validation with better error messages
          set +e
          VALIDATION_RESULT=$(node validate-wrapper.js resume-base.json 2>&1)
          VALIDATION_EXIT_CODE=$?
          set -e
          
          if [ "$VALIDATION_EXIT_CODE" -eq 0 ]; then
            echo "validation_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_status=failed" >> "$GITHUB_OUTPUT"
            {
              echo "validation_output<<EOF"
              echo "$VALIDATION_RESULT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment on validation failure
        if: steps.validate.outputs.validation_status == 'failed' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get validation error from step output
          VALIDATION_OUTPUT="${{ steps.validate.outputs.validation_output }}"
          
          # Create a unique identifier for our validation comment
          COMMENT_MARKER="<!-- resume-validation-workflow-comment -->"
          
          # Create comment body (using printf for proper formatting)
          # shellcheck disable=SC2016
          printf -v COMMENT_BODY '%s\n%s\n\n%s\n\n```text\n%s\n```\n\n%s' \
            "$COMMENT_MARKER" \
            "## ❌ Resume Validation Failed" \
            "The resume validation failed with the following errors:" \
            "$VALIDATION_OUTPUT" \
            "Please fix the validation errors and push the changes again."
          
          # Check if a comment already exists with our unique marker
          COMMENT_ID=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq ".comments[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$COMMENT_BODY"
          else
            # Create new comment
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          fi

      - name: Fail workflow if validation failed
        if: steps.validate.outputs.validation_status == 'failed'
        run: exit 1

  publish-resume:
      needs: validate-resume
      runs-on: ubuntu-latest
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      permissions:
        contents: read
        
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Publish resume to gist
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            gh gist edit 8e587fe79ca40a637589b1d2d5c9373d resume-base.json