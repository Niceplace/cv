name: Validate CV

on:
  push:
    branches:
      - main
    paths:
      - 'resume-*.json'
  pull_request:
    branches:
      - main
    paths:
      - 'resume-*.json'

jobs:
  validate-resume:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 'lts/*'

      - name: Install validation dependencies
        run: npm install resumed

      - name: Validate resume
        id: validate
        run: |
          # Note: resume-base.json is the canonical CV file per repository conventions
          
          # Run validation using the script in .github/scripts/validate-resume.js
          set +e
          VALIDATION_RESULT=$(node .github/scripts/validate-resume.js resume-base.json 2>&1)
          VALIDATION_EXIT_CODE=$?
          set -e
          
          if [ "$VALIDATION_EXIT_CODE" -eq 0 ]; then
            echo "validation_status=success" >> "$GITHUB_OUTPUT"
          else
            echo "validation_status=failed" >> "$GITHUB_OUTPUT"
            {
              echo "validation_output<<EOF"
              echo "$VALIDATION_RESULT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment on validation failure
        if: steps.validate.outputs.validation_status == 'failed' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get validation error from step output
          VALIDATION_OUTPUT="${{ steps.validate.outputs.validation_output }}"
          
          # Use the post-pr-comment.sh script
          bash .github/scripts/post-pr-comment.sh "$VALIDATION_OUTPUT" "${{ github.event.pull_request.number }}"

      - name: Fail workflow if validation failed
        if: steps.validate.outputs.validation_status == 'failed'
        run: exit 1

  publish-resume:
      needs: validate-resume
      runs-on: ubuntu-latest
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      permissions:
        contents: read
        
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Publish resume to gist
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            gh gist edit 8e587fe79ca40a637589b1d2d5c9373d resume-base.json