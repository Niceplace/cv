name: Update CV in niceplace.github.io

on:
  push:
    branches: [main]
    paths:
      - 'resume-*.json'
      - 'scripts/**'
      - 'themes/**'
      - '.github/workflows/publish-to-github-pages.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CV repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          path: cv

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 #v2.1.2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: cv
        run: bun install

      - name: Render CV
        working-directory: cv
        run: |
          bun run scripts/render-resume.ts modern-classic \
            --output-dir output \
            --strip-phone \
            --combined

      - name: Checkout niceplace.github.io
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          repository: Niceplace/niceplace.github.io
          path: target
          token: ${{ secrets.PUBLISH_CV_TOKEN }}

      - name: Copy rendered CV
        run: |
          mkdir -p target/public/resume
          cp cv/output/index.html target/public/resume/index.html

      - name: Configure Git
        working-directory: target
        run: |
          git config user.name "niceplace-cv-updater[bot]"
          git config user.email "niceplace-cv-updater[bot]@users.noreply.github.com"

      - name: Create and checkout branch
        working-directory: target
        run: |
          git checkout -b update-cv || git switch update-cv

      - name: Commit changes
        working-directory: target
        run: |
          git add public/resume/index.html
          git commit -m "Update resume" || echo "No changes to commit"

      - name: Push branch
        working-directory: target
        run: |
          git push origin update-cv --force

      - name: Create Pull Request
        working-directory: target
        env:
          GH_TOKEN: ${{ secrets.PUBLISH_CV_TOKEN }}
        run: |
          # Check if PR already exists
          if gh pr list --head update-cv --json number --jq '. | length' | grep -q "0"; then
            gh pr create \
              --base main \
              --head update-cv \
              --title "Update rendered resume" \
              --body "Automated resume update from Niceplace/cv"
          else
            echo "PR already exists"
          fi
