name: Update CV in niceplace.github.io

on:
  push:
    branches: [main]
    paths:
      - 'resume-*.json'
      - 'scripts/**'
      - 'themes/**'
      - '.github/workflows/publish-to-github-pages.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-cv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CV repo
        uses: actions/checkout@v6.0.1 # 8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          path: cv

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2.1.2 # 3d267786b128fe76c2f16a390aa2448b815359f3
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: cv
        run: bun install

      - name: Render CV
        working-directory: cv
        run: |
          bun run scripts/render-resume.ts modern-classic \
            --output-dir output \
            --strip-phone \
            --combined

      - name: Checkout niceplace.github.io
        uses: actions/checkout@v6.0.1 # 8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          repository: Niceplace/niceplace.github.io
          path: target
          token: ${{ secrets.PUBLISH_CV_TOKEN }}

      - name: Copy rendered CV
        run: |
          mkdir -p target/cv
          cp cv/output/index.html target/cv/index.html

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8.1.0 # c0f553fe549906ede9cf27b5156039d195d2ece0
        with:
          path: target
          token: ${{ secrets.PUBLISH_CV_TOKEN }}
          branch: update-cv
          title: "Update rendered CV"
          body: "Automated CV update from Niceplace/cv"
          commit-message: "Update CV"
